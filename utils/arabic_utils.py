# utils/arabic_utils.py - ุงููุณุฎุฉ ุงููุทูุฑุฉ ููุนุงูุฌุฉ ุงููุตูุต ูุงูุนุฑุจูุฉ ูุงูุฑููุฒ
try:
    import arabic_reshaper
    from bidi.algorithm import get_display
    HAS_ARABIC = True
except ImportError:
    HAS_ARABIC = False
import re


def ar(text):
    """
    ูููู ุจุชุดููู ุงููุต ุงูุนุฑุจู ูุนูุณู ููุธูุฑ ุจุดูู ุตุญูุญ ูู Kivy.
    """
    if not text or text is None:
        return ""
    
    # ุชุญููู ุงููุต ููููู ุณูุณูุฉ (string) ุฅุฐุง ูู ููู
    text = str(text)
    
    # ูุงููุณ ุงุณุชุจุฏุงู ุงูุฑููุฒ ุจูุตูุต ุนุฑุจูุฉ (ูุชุฌูุจ ูุฑุจุนุงุช xxxx ูู ุจุนุถ ุงูุฎุทูุท)
    replacements = {
        '๐': '', '๐': '', '๐': '', '๐': '', 'โจ': '', 'โ๏ธ': '',
        '๐': 'ุฅุฏุงุฑุฉ', '๐ช': 'ุฎุฑูุฌ', '๐': 'ุชุญุฏูุซ', '๐': 'ุชูุจูู',
        '๐': 'ุทูุจุงุช', '๐ฅ': 'ุทูุงุจ', '๐ข': 'ูุดุท', '๐': 'ููู',
        'โ': '+', '๐๏ธ': 'ุญุฐู', '๐': 'ููุงุฏ', '๐': 'ููู', '๐': 'ูุชุญ',
        'โฌ๏ธ': 'ุชูุฒูู', '๐จ': 'ุทูุจ', '๐พ': 'ุญูุธ', 'โ๏ธ': '!!', 'โ': 'X',
        'โ': 'V', 'โณ': 'ุงูุชุธุงุฑ', 'โจ': '*', 'โญ': '*', '๐': '', '๐': '',
        '๐': '', '๐': 'ูุชุงุจ', '๐': ''
    }
    
    for emoji, replacement in replacements.items():
        text = text.replace(emoji, replacement)
    
    # ุชูุธูู ุฃู ุฑููุฒ ุชุนุจูุฑูุฉ ูุชุจููุฉ ููุณุช ุถูู ุงููุงุฆูุฉ (ูููุน ุธููุฑ ูุฑุจุนุงุช xxxx)
    # ูุณุชุฎุฏู Regex ูุฅุจูุงุก ุงููุตูุต ุงูุนุฑุจูุฉ (ุจูุง ูููุง ุงูุฃุฑูุงู ูุงูุชุดููู) ูุงูุฅูุฌููุฒูุฉ ูุงูุฃุฑูุงู ูุจุนุถ ุงูุฑููุฒ ุงูุฃุณุงุณูุฉ ููุท
    # ุชูุช ุฅุถุงูุฉ ูุทุงูุงุช ุฃุฏู ููุนุฑุจูุฉ ูุถูุงู ุนุฏู ุญุฐู ุงูุญุฑูู ุฃุซูุงุก ุงููุนุงูุฌุฉ
    try:
        text = re.sub(r'[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFFa-zA-Z0-9\s!@#$%^&*()_+\-=\[\]{};\':\"\\|,.<>\/?]+', '', text)
    except:
        pass

    # ุชุดููู ุงูุญุฑูู (ูุตู ุงูุญุฑูู ุจุจุนุถูุง) ุซู ุนูุณูุง (BIDI)
    if HAS_ARABIC:
        try:
            # ุงุณุชุฎุฏุงู ุฅุนุฏุงุฏุงุช ุงูุชุฑุงุถูุฉ ูููุฉ ูููุดูู
            reshaped_text = arabic_reshaper.reshape(text)
            bidi_text = get_display(reshaped_text)
            return bidi_text
        except Exception as e:
            print(f"Arabic Reshaping Error: {e}")
            return text
    else:
        # ุฅุฐุง ูู ุชูู ุงูููุชุจุงุช ููุฌูุฏุฉุ ูุฑุฌุน ุงููุต ููุง ูู (ุณูุธูุฑ ุญุฑููุงู ูููุตูุฉ)
        # ูุฐุง ูุณุงุนุฏ ูู ุงูุชุดุฎูุต ูู ุธูุฑุช ุงูุญุฑูู ูููุตูุฉ ุฑุบู ุงูุชุนุฏูู
        print("Warning: arabic-reshaper or python-bidi not found!")
        return text
